From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: John Doe <john.doe@somewhere.on.planet>
Date: Tue, 12 Mar 2024 12:14:12 +0100
Subject: Patching u-boot sunxi64 files board/sunxi/board.c
 configs/orangepi_zero2_defconfig

Signed-off-by: John Doe <john.doe@somewhere.on.planet>
---
 board/sunxi/board.c              | 10 ++++++++--
 configs/orangepi_zero2_defconfig |  8 ++++++++
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/board/sunxi/board.c b/board/sunxi/board.c
index ec45ed3e05..9263befc43 100644
--- a/board/sunxi/board.c
+++ b/board/sunxi/board.c
@@ -143,12 +143,16 @@ enum env_location env_get_location(enum env_operation op, int prio)
 		return ENVL_NOWHERE;
 
 	switch (sunxi_get_boot_device()) {
 	case BOOT_DEVICE_MMC1:
 	case BOOT_DEVICE_MMC2:
-		if (prio == 0 && IS_ENABLED(CONFIG_ENV_IS_IN_FAT))
-			return ENVL_FAT;
+		if (prio == 0) {
+			if (IS_ENABLED(CONFIG_ENV_IS_IN_FAT))
+				return ENVL_FAT;
+			if (IS_ENABLED(CONFIG_ENV_IS_IN_EXT4))
+				return ENVL_EXT4;
+		}
 		if (IS_ENABLED(CONFIG_ENV_IS_IN_MMC))
 			return ENVL_MMC;
 		break;
 	case BOOT_DEVICE_NAND:
 		if (prio == 0 && IS_ENABLED(CONFIG_ENV_IS_IN_UBI))
@@ -177,10 +181,12 @@ enum env_location env_get_location(enum env_operation op, int prio)
 	 * or UBI, or NOWHERE, which is already handled above.
 	 */
 	if (prio == 0) {
 		if (IS_ENABLED(CONFIG_ENV_IS_IN_FAT))
 			return ENVL_FAT;
+		if (IS_ENABLED(CONFIG_ENV_IS_IN_EXT4))
+			return ENVL_EXT4;
 		if (IS_ENABLED(CONFIG_ENV_IS_IN_UBI))
 			return ENVL_UBI;
 	}
 
 	return ENVL_UNKNOWN;
diff --git a/configs/orangepi_zero2_defconfig b/configs/orangepi_zero2_defconfig
index ab6aaad5db..6d94cfc69e 100644
--- a/configs/orangepi_zero2_defconfig
+++ b/configs/orangepi_zero2_defconfig
@@ -25,5 +25,13 @@ CONFIG_AXP_DCDC3_VOLT=1500
 CONFIG_SPI=y
 CONFIG_USB_EHCI_HCD=y
 CONFIG_USB_OHCI_HCD=y
 CONFIG_USB_MUSB_GADGET=y
 CONFIG_PWRLED="PC12"
+# CONFIG_ENV_IS_IN_FAT is not set
+CONFIG_ENV_IS_IN_EXT4=y
+CONFIG_ENV_EXT4_INTERFACE="mmc"
+CONFIG_ENV_EXT4_DEVICE_AND_PART="0:1"
+CONFIG_ENV_EXT4_FILE="/boot/uboot.env"
+CONFIG_FS_EXT4=y
+CONFIG_EXT4_WRITE=y
+
-- 
Created with Armbian build tools https://github.com/armbian/build

